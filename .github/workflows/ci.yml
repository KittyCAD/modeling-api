on:
    workflow_dispatch:
    pull_request:
      paths:
        - '**.rs'
        - .github/workflows/ci.yml
        - Cargo.lock
        - Cargo.toml
        - '**/Cargo.toml'
        - rust-toolchain.toml
permissions: read-all
name: Rust CI
jobs:
    cargo-test:
      name: cargo test
      runs-on: ubuntu-latest-8-cores
      steps:
        - uses: actions/checkout@v4
        - name: Install Rust
          uses: dtolnay/rust-toolchain@stable
        - uses: taiki-e/install-action@cargo-llvm-cov
        - uses: taiki-e/install-action@nextest
        - uses: Swatinem/rust-cache@v2.7.0

        - name: cargo test
          shell: bash
          run: |
            export KITTYCAD_API_TOKEN=${{secrets.KITTYCAD_API_TOKEN}}
            cargo llvm-cov nextest --all-features --workspace --lcov --output-path lcov.info
          env:
            RUST_BACKTRACE: 1
  
        - name: Upload to codecov.io
          uses: codecov/codecov-action@v3
          with:
            token: ${{secrets.CODECOV_TOKEN}}
            fail_ci_if_error: true
            flags: unittests
            verbose: true
            files: lcov.info
  
    cargo-clippy:
      name: cargo clippy
      runs-on: ubuntu-latest-8-cores
      steps:
        - uses: actions/checkout@v4
        - name: Install Rust
          uses: dtolnay/rust-toolchain@stable
          with:
            components: clippy
        - uses: Swatinem/rust-cache@v2.7.0

        - name: Run clippy (no default features)
          shell: bash
          run: cargo clippy --tests --benches --workspace --examples --no-default-features -- -D warnings
          env:
            RUST_BACKTRACE: 1
        - name: Run clippy (only default features)
          shell: bash
          run: cargo clippy --tests --benches --workspace --examples -- -D warnings
          env:
            RUST_BACKTRACE: 1
        - name: Run clippy (all features)
          shell: bash
          run: cargo clippy --tests --benches --workspace --examples --all-features -- -D warnings
          env:
            RUST_BACKTRACE: 1
 
    cargo-fmt:
        name: cargo fmt
        runs-on: ubuntu-latest-8-cores
        steps:
          - uses: actions/checkout@v4
          - name: Install Rust
            uses: dtolnay/rust-toolchain@stable
            with:
                components: rustfmt
  
          - name: cargo fmt
            shell: bash
            run: |
              cargo fmt
            env:
              RUST_BACKTRACE: 1

    check-typos:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout
          uses: actions/checkout@v4
        - name: Set up Python
          uses: actions/setup-python@v4
        - name: Install codespell
          run: python -m pip install codespell
        - name: Run codespell
          # Edit this file to tweak the typo list and other configuration.
          run: codespell --config .codespellrc

    cargo-toml-sorted:
      name: Check Cargo.toml is sorted
      runs-on: ubuntu-latest
      steps:
        - name: Checkout
          uses: actions/checkout@v4
        - name: Install cargo-sort
          run: cargo install cargo-sort
        - name: Run check
          run: cargo sort --workspace --check

    semver-checks:
      runs-on: ubuntu-latest
      steps:
        - name: Checkout
          uses: actions/checkout@v4
        - name: Check semver
          uses: obi1kenobi/cargo-semver-checks-action@v2
          with:
            package: kittycad-modeling-cmds
